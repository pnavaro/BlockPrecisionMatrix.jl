@testset "IWT block precision" begin

using UnicodePlots

import PrecisionMatrix: structure_cov, cov_simu, generate_data
import PrecisionMatrix: permute, permute_scad, iwt_block_precision

p = 10 
n = 500
b = 3
rng = MersenneTwister(12)
blocs_on  = [[1,3]]

covmat, premat, data, blocks = generate_data(rng, p, n, b, blocs_on)

include("test_data.jl")

@test data ≈ ref

@test covmat ≈ [0.006703039449117335 -0.0011974734120262097 0.002630890805320452 0.00030530407409831164 -0.001102583236933177 0.0 0.0 0.0 0.00032415941601134774 -0.0008412266609940409; -0.0011974734120262097 0.004167897855422664 0.0006464269410540235 -4.205337131213614e-5 -0.0010213618372514304 0.0 0.0 0.0 -0.0017671905259599807 0.0031382988512826163; 0.002630890805320452 0.0006464269410540235 0.0047317796334182165 -0.001085697176212317 0.0015877945489023884 0.0 0.0 0.0 -0.001375584379217397 -0.0010417453496444533; 0.00030530407409831164 -4.205337131213614e-5 -0.001085697176212317 0.008493826379716404 -0.000474052882708975 0.0 0.0 0.0 -0.0011960085886084473 -0.0015023059877447675; -0.001102583236933177 -0.0010213618372514304 0.0015877945489023884 -0.000474052882708975 0.004230078763533222 0.0 0.0 0.0 0.0025455621295199095 -0.0013246570302212649; 0.0 0.0 0.0 0.0 0.0 0.002510410894270122 -0.0019635430761109993 0.0002990789489446945 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 -0.0019635430761109993 0.0061654215428903385 -0.0015208470244641422 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0002990789489446945 -0.0015208470244641422 0.0017409564296772533 0.0 0.0; 0.00032415941601134774 -0.0017671905259599807 -0.001375584379217397 -0.0011960085886084473 0.0025455621295199095 0.0 0.0 0.0 0.006045072537452851 0.00017771838011904233; -0.0008412266609940409 0.0031382988512826163 -0.0010417453496444533 -0.0015023059877447675 -0.0013246570302212649 0.0 0.0 0.0 0.00017771838011904233 0.004837423201249129]

@test premat ≈ [118.40986759110969 -2.0773163657994576 11.54932461506734 10.465198624305868 -36.10627979384375 0.0 0.0 0.0 37.16891929646807 26.289863920230488; -2.0773163657994593 93.24996433720993 42.416638878550884 30.86438580572865 28.50330700028755 0.0 0.0 0.0 9.094929023312018 67.37229259408232; 11.54932461506734 42.41663887855089 98.35564785330634 1.9444108193125103 60.40678306446141 0.0 0.0 0.0 -23.786094051348552 -7.080545857223506; 10.465198624305867 30.86438580572865 1.9444108193125145 121.37577122779317 24.30567101866923 0.0 0.0 0.0 21.441084871729004 11.598905407281652; -36.10627979384374 28.50330700028755 60.4067830644614 24.30567101866923 103.63001279200417 0.0 0.0 0.0 35.88892854912048 -5.274044646667201; 0.0 0.0 0.0 0.0 0.0 537.6531922996002 189.22097736319955 72.93428288887965 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 189.22097736319955 273.3400818422603 206.27537426372476 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 72.9342828888797 206.27537426372479 742.063476419264 0.0 0.0; 37.16891929646807 9.094929023312018 -23.786094051348552 21.441084871729004 35.88892854912049 0.0 0.0 0.0 225.17994057886622 -58.097054997630714; 26.28986392023049 67.37229259408232 -7.080545857223512 11.598905407281656 -5.274044646667202 0.0 0.0 0.0 -58.097054997630714 303.02161831116456]


display(heatmap(covmat, title="covmat"))
display(heatmap(premat, title="premat"))

@time pval = iwt_block_precision(rng, data, blocks; B=1000)

display(heatmap(pval, title="pval"))

@test pval ≈ [0.0 0.0 0.0 0.0 0.0 0.843 0.843 0.843 0.683 0.683; 0.0 0.0 0.0 0.0 0.0 0.843 0.843 0.843 0.683 0.683; 0.0 0.0 0.0 0.0 0.0 0.843 0.843 0.843 0.683 0.683; 0.0 0.0 0.0 0.0 0.0 0.843 0.843 0.843 0.683 0.683; 0.0 0.0 0.0 0.0 0.0 0.843 0.843 0.843 0.683 0.683; 0.843 0.843 0.843 0.843 0.843 0.0 0.0 0.0 0.683 0.683; 0.843 0.843 0.843 0.843 0.843 0.0 0.0 0.0 0.683 0.683; 0.843 0.843 0.843 0.843 0.843 0.0 0.0 0.0 0.683 0.683; 0.683 0.683 0.683 0.683 0.683 0.683 0.683 0.683 0.0 0.0; 0.683 0.683 0.683 0.683 0.683 0.683 0.683 0.683 0.0 0.0]

end
